# version: "3.9"
# services:
#   mcp-server:
#     build:
#       context: ..
#       dockerfile: docker/Dockerfile.mcp
#     ports:
#       - "9000:9000"
#     env_file:
#       - ../.env

#   agent-worker:
#     build:
#       context: ..
#       dockerfile: docker/Dockerfile.agent
#     depends_on:
#       - mcp-server
#     env_file:
#       - ../.env

services:
  mcp-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile.mcp
    container_name: mcp-server-container
    ports:
      - "8100:8100"
    env_file:
      - ../.env
    environment:
      - MCP_SERVER_PORT=8100
    volumes:
      - ../src:/app/src
      - ../data:/app/data
      - ../.env:/app/.env
      - ../requirements.txt:/app/requirements.txt
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - pe-dashboard-network
    command: ["uvicorn", "src.server.mcp_server:app", "--host", "0.0.0.0", "--port", "8100"]

  airflow:
    # Upgraded to Airflow 3.1.0 for native HITLOperator support
    # Revert to apache/airflow:2.10.0 if compatibility issues arise
    image: apache/airflow:3.1.0
    container_name: airflow-container
    depends_on:
      - mcp-server
    environment:
      - AIRFLOW__CORE__EXECUTOR=SequentialExecutor
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      - AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION=true
      - MCP_SERVER_URL=http://mcp-server:8100
    volumes:
      - ../airflow/dags:/opt/airflow/dags
      - ../requirements.txt:/opt/airflow/requirements.txt
      - ../data:/opt/airflow/data
      - ../src:/opt/airflow/src
      - ../.env:/opt/airflow/.env
      - ../config:/opt/airflow/config
    ports:
      - "8080:8080"
    # Airflow 3.x commands: 'db init' -> 'db migrate', 'webserver' -> 'api-server'
    # Revert to old commands if downgrading to Airflow 2.x
    command: >
      bash -c "
      pip install -r /opt/airflow/requirements.txt &&
      airflow db migrate &&
      airflow users create --username admin --firstname Admin --lastname User --role Admin --email admin@example.com --password admin 2>/dev/null || true &&
      rm -f /opt/airflow/airflow-api-server.pid &&
      (airflow api-server --port 8080 &) &&
      airflow scheduler
      "
    networks:
      - pe-dashboard-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3  
  
  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    container_name: api-container
    depends_on:
      - mcp-server
    env_file:
      - ../.env
    environment:
      - PORT=8000
      # - MCP_SERVER_URL=http://mcp-server:8100
      # - GOOGLE_APPLICATION_CREDENTIALS=/app/src/storage/service_account.json
      # - ENVIRONMENT=local
    ports:
      - "8000:8000"
    volumes:
      - ../src:/app/src
      - ../data:/app/data
      - ../.env:/app/.env
      - ../requirements.txt:/app/requirements.txt
    command: ["uvicorn", "src.api:app", "--host", "0.0.0.0", "--port", "8080"]
    networks:
      - pe-dashboard-network

  streamlit:
    build:
      context: ..
      dockerfile: docker/Dockerfile.streamlit
    container_name: streamlit-container
    depends_on:
      - api
      - mcp-server
    env_file:
      - ../.env
    environment:
      - API_BASE_URL=http://api:8080   # Streamlit -> FastAPI inside Docker
      - MCP_SERVER_URL=http://mcp-server:8100
      - PORT=8080
    volumes:
      - ../src:/app/src
      - ../data:/app/data
      - ../.env:/app/.env
    ports:
      - "8501:8080"   # host:container
    command: ["streamlit", "run", "src/streamlit_app.py", "--server.port", "8080", "--server.address", "0.0.0.0"]
    networks:
      - pe-dashboard-network

  streamlit-hitl:
    build:
      context: ..
      dockerfile: docker/Dockerfile.streamlit
    container_name: streamlit-hitl-container
    depends_on:
      - api
      - mcp-server
    env_file:
      - ../.env
    environment:
      - API_BASE_URL=http://api:8080   # Streamlit -> FastAPI inside Docker
      - MCP_SERVER_URL=http://mcp-server:8100
      - PORT=8080
    volumes:
      - ../src:/app/src
      - ../data:/app/data
      - ../.env:/app/.env
    ports:
      - "8502:8080"   # host:container
    command: ["streamlit", "run", "src/approval_ui.py", "--server.port", "8080", "--server.address", "0.0.0.0"]
    networks:
      - pe-dashboard-network

networks:
  pe-dashboard-network:
    driver: bridge

volumes:
  airflow-db:
    driver: local